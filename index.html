<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generating the Dungeon</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .logo {
            display: block;
            margin: 0 auto 5px auto;
            max-width: 100%;
            height: auto;
        }

        h1 {
            text-align: center;
            font-size: 2em;
            margin-top: 0;
            margin-bottom: 20px;
        }

            h1 a.help-icon {
                text-decoration: none;
                font-size: 0.9em;
                vertical-align: middle;
                margin-left: 10px;
                color: red;
            }

        .button-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 5px 0;
            font-size: 1.2em;
            cursor: pointer;
        }

        .result-area {
            width: 100%;
            max-width: 500px;
            min-height: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 0 auto;
            white-space: pre-wrap;
            background: #f9f9f9;
        }

        select, .switch-container {
            width: 100%;
            max-width: 500px;
            padding: 10px;
            font-size: 1.1em;
            margin: 20px auto 0 auto;
            display: block;
        }


        .reveal-button {
            display: inline-block;
            margin: 5px 0;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .hidden-treasure {
            border: 1px dashed #aaa;
            padding: 5px;
            margin-top: 5px;
            background: #fff;
        }

        #csv-area {
            width: 100%;
            overflow-x: auto; /* Allows horizontal scrolling if the table is too wide */
        }

            #csv-area table {
                width: 100%;
                border-collapse: collapse;
                table-layout: auto;
            }

                #csv-area table th,
                #csv-area table td {
                    word-wrap: break-word;
                    white-space: normal;
                    padding: 4px;
                }

    </style>
</head>
<body>
    <img src="images/logo.png" alt="Logo" class="logo">
    <h1>Generating the Dungeon <a href="#" class="help-icon" onclick="toggleHelp()">?</a></h1>
    
    <div class="button-container">
        <button onclick="generateDungeon()">Generate Dungeon</button>
        <button onclick="generateMonster()">Generate Monster</button>
        <button onclick="generateTreasure()">Generate Treasure</button>
    </div>

    <div class="switch-container">
        <label>
            <input type="checkbox" id="verbose" onchange="toggleVerbose()"> Show Details
        </label>
    </div>

    <div class="result-area" id="result"></div>
    <div id="csv-area"></div>

    <select id="subdir-dropdown">
        <option value="">Select a directory</option>
    </select>

    <script>
        function generateDungeon() {
            const verbose = document.getElementById('verbose').checked ? '1' : '0';
            fetch(`src/index.php?tables=dungeon&verbose=${verbose}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('result').innerHTML = data;
                    processCSVMarker(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function generateMonster() {
            const verbose = document.getElementById('verbose').checked ? '1' : '0';
            fetch(`src/index.php?tables=monster&verbose=${verbose}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('result').innerHTML = data;
                    processCSVMarker(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function generateTreasure() {
            const verbose = document.getElementById('verbose').checked ? '1' : '0';
            fetch(`src/index.php?tables=treasure&verbose=${verbose}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('result').innerHTML = data;
                    processCSVMarker(data);
                })
                .catch(error => console.error('Error:', error));
        }

        function toggleVerbose() {
            const verbose = document.getElementById('verbose').checked;
            // Store the verbose setting in localStorage
            localStorage.setItem('verbose', verbose);
        }

        function toggleHelp() {
            const helpText = `
                <h3>How to Use</h3>
                <p>1. Click any of the generation buttons to create content</p>
                <p>2. Toggle "Show Details" to see the generation process</p>
                <p>3. Monster stats will appear automatically when monsters are generated</p>
            `;
            alert(helpText);
        }

        function processCSVMarker(data) {
            const csvArea = document.getElementById('csv-area');
            const markerIndex = data.indexOf('##CSV_MARKER##');
            
            if (markerIndex !== -1) {
                const csvContent = data.substring(markerIndex + '##CSV_MARKER##'.length);
                csvArea.innerHTML = csvContent;
            } else {
                csvArea.innerHTML = '';
            }
        }

        // Load saved verbose setting
        document.addEventListener('DOMContentLoaded', function() {
            const savedVerbose = localStorage.getItem('verbose') === 'true';
            document.getElementById('verbose').checked = savedVerbose;
        });

        async function fetchSubdirectories() {
            try {
                const response = await fetch('list_dirs.php');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const subdirs = await response.json();
                const dropdown = document.getElementById('subdir-dropdown');
                subdirs.forEach(dir => {
                    const option = document.createElement('option');
                    option.value = dir;
                    option.textContent = dir;
                    dropdown.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching subdirectories:", error);
            }
        }
        fetchSubdirectories();
    </script>
</body>
</html>
